<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Risko - Kayıt Ol</title>
    <link rel="icon" type="image/svg+xml" href="./favicon.svg">
    <meta name="description" content="Risko - Gelişmiş Risk Analizi Sistemi">
    <meta name="author" content="Kürşat">
    
    <!-- External Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: #000; /* siyah arkaplan */
            color: #fff;
            min-height: 100vh; display: flex; align-items: center; justify-content: center;
        }
        .register-container {
            background: #0a0a0a;
            border: 1px solid #1f1f1f;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.6);
            padding: 2.25rem; width: 100%; max-width: 520px; margin: 2rem;
        }
        .register-header { text-align: center; margin-bottom: 1.5rem; }
    .register-header h1 { color: #fff; font-weight: 800; margin-bottom: .25rem; }
    .register-header p { color: #b3b3b3; font-weight: 500; }
    .form-control { background:#0f0f0f; color:#f5f5f5; border: 1px solid #2a2a2a; border-radius: 12px; padding: .9rem; font-weight: 500; transition: all .25s ease; }
    .form-control:focus { border-color: #fff; box-shadow: 0 0 0 .2rem rgba(255,255,255,.15); background:#121212; }
    ::placeholder { color:#9b9b9b; }
    .btn-register { background: #fff; color:#000; border: none; padding: 0.9rem 1rem; border-radius: 12px; font-weight: 700; font-size: 1.05rem; transition: all .2s ease; width: 100%; margin-top: .5rem; }
    .btn-register:hover { transform: translateY(-1px); box-shadow: 0 10px 25px rgba(255,255,255,.1); }
        .terms { font-size: .9rem; color: #64748b; }
        .alt-link { text-align: center; margin-top: 1rem; }
    </style>
</head>
<body>
    <div class="register-container">
        <div class="register-header">
            <i class="fas fa-user-plus fa-3x text-success mb-3"></i>
            <h1>Risko</h1>
            <p>Hesap Oluştur</p>
        </div>

        <form id="registerForm" onsubmit="handleRegister(event)">
            <div class="row g-3">
                <div class="col-12">
                    <label class="form-label fw-semibold"><i class="fas fa-user me-2 text-success"></i>Ad Soyad</label>
                    <input type="text" class="form-control" id="name" placeholder="Ad Soyad" required>
                </div>
                <div class="col-12">
                    <label class="form-label fw-semibold"><i class="fas fa-envelope me-2 text-success"></i>E-posta</label>
                    <input type="email" class="form-control" id="email" placeholder="ornek@eposta.com" required>
                </div>
                <div class="col-12">
                    <label class="form-label fw-semibold"><i class="fas fa-lock me-2 text-success"></i>Şifre</label>
                    <input type="password" class="form-control" id="password" placeholder="En az 8 karakter" minlength="8" required>
                </div>
                <div class="col-12">
                    <label class="form-label fw-semibold"><i class="fas fa-lock me-2 text-success"></i>Şifre (Tekrar)</label>
                    <input type="password" class="form-control" id="password2" placeholder="Şifrenizi tekrar girin" minlength="8" required>
                </div>
                <div class="col-12 form-check mt-2">
                    <input class="form-check-input" type="checkbox" id="terms" required>
                    <label class="form-check-label terms" for="terms">Kullanım şartlarını ve gizlilik politikasını kabul ediyorum.</label>
                </div>
            </div>

            <button type="submit" class="btn btn-success btn-register">
                <i class="fas fa-user-check me-2"></i>Kayıt Ol
            </button>
        </form>

        <div class="alt-link">
            Zaten hesabın var mı? <a href="./login.html" class="text-decoration-none">Giriş Yap</a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.10.0/dist/sweetalert2.all.min.js"></script>
    <script src="./config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="./supabase-client.js"></script>
    <script>
    async function handleRegister(event){
            event.preventDefault();
            const name = document.getElementById('name').value.trim();
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const password2 = document.getElementById('password2').value;

            if(password !== password2){
                Swal.fire({ icon: 'error', title: 'Şifreler eşleşmiyor', text: 'Lütfen aynı şifreyi girin.' });
                return;
            }

            Swal.fire({ title: 'Hesap oluşturuluyor...', allowOutsideClick: false, showConfirmButton: false, didOpen: () => Swal.showLoading() });

            try {
                const cfg = window.RISKO_CONFIG || {};
                // Try Supabase first
                if (window.RiskoAuth) await window.RiskoAuth.init();
                if (window.RiskoAuth && window.RiskoAuth.enabled) {
                    // Register then immediately attempt to sign in using the same credentials.
                    await window.RiskoAuth.register(name, email, password);
                    try {
                        const loginRes = await window.RiskoAuth.login(email, password);
                        // loginRes should contain session and user when successful
                        const access = loginRes?.session?.access_token || await window.RiskoAuth.getToken();
                        const refresh = loginRes?.session?.refresh_token || '';
                        if (!access) {
                            // If no token available, inform the user (possible email confirmation requirement)
                            Swal.fire({ icon: 'info', title: 'Kayıt tamamlandı', text: 'Lütfen e-posta adresinizi onaylayın. Onay sonrası giriş yapılabilir.' });
                            return;
                        }
                        localStorage.setItem('risko_access_token', access);
                        localStorage.setItem('risko_refresh_token', refresh);
                        sessionStorage.setItem('risko_user', JSON.stringify(loginRes.user || {}));
                        Swal.fire({ icon: 'success', title: 'Kayıt başarılı', text: 'Uygulamaya yönlendiriliyorsunuz...', timer: 1000, showConfirmButton: false })
                            .then(() => window.location.href = './app.html');
                        return;
                    } catch (e) {
                        console.error('Otomatik giriş başarısız:', e);
                        Swal.fire({ icon: 'info', title: 'Kayıt tamamlandı', text: 'Hesap oluşturuldu. Lütfen e-posta onayını kontrol edin veya giriş sayfasından giriş yapın.' });
                        return;
                    }
                }

                // If Supabase not enabled, only fall back to backend if API_BASE_URL is explicitly configured
                if (!cfg.API_BASE_URL) {
                    Swal.fire({ icon: 'error', title: 'Servis yapılandırılmamış', text: 'Kimlik doğrulama yapılandırması bulunamadı. Lütfen daha sonra tekrar deneyin.' });
                    return;
                }

                // Backend fallback (only when API_BASE_URL provided)
                const res = await fetch(`${cfg.API_BASE_URL}/api/v1/auth/register`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name, email, password }) });
                if (!res.ok) throw new Error('register failed');
                const body = new URLSearchParams(); body.append('username', email); body.append('password', password);
                const loginRes = await fetch(`${cfg.API_BASE_URL}/api/v1/auth/login`, { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body });
                if (!loginRes.ok) throw new Error('login failed');
                const token = await loginRes.json(); localStorage.setItem('risko_access_token', token.access_token);
                Swal.fire({ icon: 'success', title: 'Kayıt başarılı', text: 'Uygulamaya yönlendiriliyorsunuz...', timer: 1000, showConfirmButton: false }).then(() => window.location.href = './app.html');
            } catch (e) {
                Swal.fire({ icon: 'error', title: 'Kayıt başarısız', text: 'Sunucuya ulaşılamıyor veya e-posta kullanımda.' });
            }
        }
    </script>
</body>
</html>
